


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using the Cyclus Preprocessor &mdash; Home</title>
    
    <link rel="stylesheet" href="../_static/cyclus.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '(1.0.0-rc4-19-g5a1e3ec)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../_static/big_c.ico"/>
    <link rel="top" title="Home" href="../index.html" />
    <link rel="up" title="Cyclus Archetype Developer Guide" href="main.html" />
    <link rel="next" title="Testing Agents and Modules" href="testing.html" />
    <link rel="prev" title="Building Modules with CMake" href="cmake.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1"><script type="text/javascript">
var ga_enabled = !$.cookie('disable-ga');
if(ga_enabled){
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12222727-2']);
  _gaq.push(['_setCookiePath', '/']);
  _gaq.push(['_setDetectFlash', false]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
}
</script>
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="testing.html" title="Testing Agents and Modules"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="cmake.html" title="Building Modules with CMake"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Home</a> &raquo;</li>

          <li><a href="main.html" accesskey="U"><span style="font-variant:small-caps;">Cyclus</span> Archetype Developer Guide</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="using-the-cyclus-preprocessor">
<span id="cycpp"></span><h1>Using the Cyclus Preprocessor<a class="headerlink" href="#using-the-cyclus-preprocessor" title="Permalink to this headline">¶</a></h1>
<table style="width:100%">
<tr><td><p>A key part of the <span style="font-variant:small-caps;">Cyclus</span> agent and module development infrastructure is
a <span style="font-variant:small-caps;">Cyclus</span>-aware C++ preprocessor called <tt class="docutils literal"><span class="pre">cycpp</span></tt>.  This preprocessor
inspects the agents that you write and then - based on the directives you
have given it - generates code that conforms to the <span style="font-variant:small-caps;">Cyclus</span> agent API.
This allows you to focus on coding up the desired agent behavior rather
than worrying about the tedious and error-prone process of making your
agents conform to the <span style="font-variant:small-caps;">Cyclus</span> kernel.</p>
<p>Before we continue there are a couple of noteworthy points about <tt class="docutils literal"><span class="pre">cycpp</span></tt>:</p>
<ul class="simple">
<li>Even when using the preprocessor agents are still completely valid C++
and may be compiled even without running <tt class="docutils literal"><span class="pre">cycpp</span></tt> (though they probably
won&#8217;t do the correct thing in a simulation).</li>
<li>If your module is compiled with the CMake macros found in UseCyclus,
<tt class="docutils literal"><span class="pre">cycpp</span></tt> is run automatically for you on all relevant files.</li>
</ul>
<p>Without further ado, let&#8217;s dive in!</p>
</td><td style="width:300px;"><a class="reference internal image-reference" href="../_images/pennyfarthing-jack.jpg"><img alt="../_images/pennyfarthing-jack.jpg" class="align-center" src="../_images/pennyfarthing-jack.jpg" style="width: 300px;" /></a>
</td></tr>
</table><div class="section" id="pragma-cyclus">
<h2>Pragma <span style="font-variant:small-caps;">Cyclus</span><a class="headerlink" href="#pragma-cyclus" title="Permalink to this headline">¶</a></h2>
<p>The preprocessor functions by defining a suite of <span style="font-variant:small-caps;">Cyclus</span>-directives that
<tt class="docutils literal"><span class="pre">cycpp</span></tt> picks up (but that plain old <tt class="docutils literal"><span class="pre">cpp</span></tt> ignores).  These all start
with the prefix <tt class="docutils literal"><span class="pre">#pragma</span> <span class="pre">cyclus</span></tt> and fall into one of two broad categories:</p>
<ol class="arabic simple">
<li><strong>Annotation directives</strong> and</li>
<li><strong>Code generation directives</strong>.</li>
</ol>
<p>The annotation directives allow you specify information and metadata
(documentation, default values, maximum shape sizes, etc.) about your agents.
The code generation directives replace themselves with C++ code inside of the
agents based on the annotations provided. <em>The use of these directives is
entirely optional.</em>  However, in their absence you must implement the
corresponding agent API yourself.</p>
</div>
<div class="section" id="annotation-directives">
<h2>Annotation Directives<a class="headerlink" href="#annotation-directives" title="Permalink to this headline">¶</a></h2>
<p><span style="font-variant:small-caps;">Cyclus</span> agents are based on the notion of <strong>state variables</strong>.  These are
member variables of your agents whose values (should) fully determine the
state of the your agent at any time step. State variables are important
because they are what is written to and read from the database, they may be
specified in the input file and have an associated schema, and they define the
public interface for the agent.</p>
<p>Thus, the most important annotation directive is the <strong>state variable
directive</strong>.  This must be written within the agent&#8217;s class declaration and
applies to the next member variable declaration that it sees. This directive
not only defines the annotations for a variable, but also declares it as being
a state variable.  It has the following signature:</p>
<p><strong>State variable annotation signature:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus var &lt;dict&gt;</span>
</pre></div>
</div>
<p>Here, the <tt class="docutils literal"><span class="pre">&lt;dict&gt;</span></tt> argument must evaluate to a Python dictionary (or other mapping).
For example,</p>
<p><strong>State variable annotation example:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus var {&quot;default&quot;: 42.0, &quot;units&quot;: &quot;n/cm2/s&quot;}</span>
<span class="kt">double</span> <span class="n">flux</span><span class="p">;</span>
</pre></div>
</div>
<p>These two lines declare that the member variable <tt class="docutils literal"><span class="pre">flux</span></tt> is in fact a state
variable of type double with the given metadata.  The keys of this dictionary
may be anything you desire, though because they are eventually persisted to
JSON the keys must be have a string types. Certain keys have special semantic
meaning and there are two - <tt class="docutils literal"><span class="pre">type</span></tt> and <tt class="docutils literal"><span class="pre">index</span></tt> - that are set by <tt class="docutils literal"><span class="pre">cycpp</span></tt>
and should not be specified explicitly. State variables my have any C++ type
that is allowed by the database backend that is being used.  For a listing of
valid types please refer to the <a class="reference internal" href="dbtypes.html"><em>Database Types</em></a> page. <a class="reference internal" href="#cycpp-table-1"><em>Table I. Special State Variable Annotations</em></a>
contains a listing of all special keys and their meaning.</p>
<table border="1" class="styled-table centered docutils" id="cycpp-table-1">
<caption><strong>Table I.</strong> Special State Variable Annotations</caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="left-align no-left-divider single-right-divider head">key</th>
<th class="left-align single-left-divider no-right-divider head">meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">type</td>
<td class="left-align single-left-divider no-right-divider">The C++ type.  Valid types may be found on the <a class="reference internal" href="dbtypes.html"><em>Database Types</em></a>
page. <strong>DO NOT SET</strong>.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">index</td>
<td class="left-align single-left-divider no-right-divider">Which number state variable is this, 0-indexed,
<strong>DO NOT SET</strong>.</td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">default</td>
<td class="left-align single-left-divider no-right-divider">The default value for this variable that is used if otherwise
unspecified. The value must match the type of the variable.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">shape</td>
<td class="left-align single-left-divider no-right-divider">The shape of a variable length datatypes. If present this must
be a list of integers whose length (rank) makes sense for this
type. Specifying positive values will (depending on the
backend) turn a variable length type into a fixed length one
with the length of the given value. Putting a <tt class="docutils literal"><span class="pre">-1</span></tt> in the
shape will retain the variable length nature along that axis.
Fixed length variables are normally more performant so it is
often a good idea to specify the shape where possible. For
example, a length-5 string would have a shape of <tt class="docutils literal"><span class="pre">[5]</span></tt> and
a length-10 vector of variable length strings would have a
shape of <tt class="docutils literal"><span class="pre">[10,</span> <span class="pre">-1]</span></tt>.</td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">doc</td>
<td class="left-align single-left-divider no-right-divider">Documentation string.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">tooltip</td>
<td class="left-align single-left-divider no-right-divider">Brief documentation string for user interfaces.</td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">units</td>
<td class="left-align single-left-divider no-right-divider">The physical units, if any.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">userlevel</td>
<td class="left-align single-left-divider no-right-divider">Integer from 0 - 10 for representing ease (0) or difficulty (10)
in using this variable, default 0.</td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">initfromcopy</td>
<td class="left-align single-left-divider no-right-divider">Code snippet to use in the <tt class="docutils literal"><span class="pre">InitFrom(Agent*</span> <span class="pre">m)</span></tt> function for
this state variable instead of using code generation.
This is a string.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">initfromdb</td>
<td class="left-align single-left-divider no-right-divider">Code snippet to use in the <tt class="docutils literal"><span class="pre">InitFrom(QueryableBackend*</span> <span class="pre">b)</span></tt>
function for this state variable instead of using code generation.
This is a string.</td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">infiletodb</td>
<td class="left-align single-left-divider no-right-divider">Code snippets to use in the <tt class="docutils literal"><span class="pre">InfileToDb()</span></tt> function
for this state variable instead of using code generation.
This is a dictionary of string values with the two keys &#8216;read&#8217;
and &#8216;write&#8217; which represent reading values from the input file
writing them out to the database respectively.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">schema</td>
<td class="left-align single-left-divider no-right-divider">Code snippet to use in the <tt class="docutils literal"><span class="pre">schema()</span></tt> function for
this state variable instead of using code generation.
This is a string.</td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">snapshot</td>
<td class="left-align single-left-divider no-right-divider">Code snippet to use in the <tt class="docutils literal"><span class="pre">Snapshot()</span></tt> function for
this state variable instead of using code generation.
This is an RNG string.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">snapshotinv</td>
<td class="left-align single-left-divider no-right-divider">Code snippet to use in the <tt class="docutils literal"><span class="pre">SnapshotInv()</span></tt> function for
this state variable instead of using code generation.
This is a string.</td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">initinv</td>
<td class="left-align single-left-divider no-right-divider">Code snippet to use in the <tt class="docutils literal"><span class="pre">InitInv()</span></tt> function for
this state variable instead of using code generation.
This is a string.</td>
</tr>
</tbody>
</table>
<br /><hr class="docutils" />
<p><span style="font-variant:small-caps;">Cyclus</span> also has a notion of class-level <strong>agent annotations</strong>. These are
specified by the <strong>note directive</strong>. Similarly to the state variable
annotations, agent annotations must be given inside of the class declaration.
They also have a very similar signature:</p>
<p><strong>Note (agent annotation) signature:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus note &lt;dict&gt;</span>
</pre></div>
</div>
<p>Again, the <tt class="docutils literal"><span class="pre">&lt;dict&gt;</span></tt> argument here must evaluate to a Python dictionary.
For example,</p>
<p><strong>Note (agent annotation) example:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus note {&quot;doc&quot;: &quot;If I wanna be rich, I’ve got to find myself&quot;}</span>
</pre></div>
</div>
<p>Unlike state variables, agent annotations only have a few special members.  One of
this is <tt class="docutils literal"><span class="pre">vars</span></tt> which contains the state variable annotations!
<a class="reference internal" href="#cycpp-table-2"><em>Table II. Special Agent Annotations</em></a> contains a listing of all special keys and their meaning.</p>
<table border="1" class="styled-table centered docutils" id="cycpp-table-2">
<caption><strong>Table II.</strong> Special Agent Annotations</caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="left-align no-left-divider single-right-divider head">key</th>
<th class="left-align single-left-divider no-right-divider head">meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">vars</td>
<td class="left-align single-left-divider no-right-divider">The state variable annotations, <strong>DO NOT SET</strong>.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">doc</td>
<td class="left-align single-left-divider no-right-divider">Documentation string.</td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">tooltip</td>
<td class="left-align single-left-divider no-right-divider">Brief documentation string for user interfaces.</td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">userlevel</td>
<td class="left-align single-left-divider no-right-divider">Integer from 0 - 10 for representing ease (0) or difficulty (10)
in using this variable, default 0.</td>
</tr>
</tbody>
</table>
<br /><hr class="docutils" />
<p>If you find dictionaries too confining, <tt class="docutils literal"><span class="pre">cycpp</span></tt> also has an <strong>exec directive</strong>.
This allows you to execute arbitrary Python code which is added to the global
namespace the state variables and agent annotations are evaluated within.  This
directive may be placed anywhere and is not confined to the class declaration,
like above.  However, it is only executed during the annotations phase of
preprocessing.  The signature for this directive is:</p>
<p><strong>Exec signature:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus exec &lt;code&gt;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">&lt;code&gt;</span></tt> argument may be any valid Python code. A non-trivial example,</p>
<p><strong>Exec example:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus exec from math import pi</span>
<span class="cp">#pragma cyclus exec r = 10</span>

<span class="cp">#pragma cyclus var {&quot;default&quot;: 2*pi*r}</span>
<span class="kt">float</span> <span class="n">circumfrence</span><span class="p">;</span>
</pre></div>
</div>
<p>One possible use for this is to keep all state variable annotations in a
separate sidecar <tt class="docutils literal"><span class="pre">*.py</span></tt> file and then import and use them rather than
cluttering up the C++ source code.  Such decisions are up to the style of the
developer.</p>
</div>
<div class="section" id="code-generation-directives">
<h2>Code Generation Directives<a class="headerlink" href="#code-generation-directives" title="Permalink to this headline">¶</a></h2>
<p>Once all of the annotations have been accumulated, the preprocessor takes
<em>another</em> pass through the code.  This time it ignores the annotations
directives and injects C++ code anytime it sees a valid code generation
directive.</p>
<p>The simplest and most powerful of the code generators is known as <strong>the prime
directive</strong>. This engages all possible code generation routines and must live
within the public part of the class declaration.</p>
<p><strong>The prime directive:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus</span>
</pre></div>
</div>
<p>Unless you are doing something fancy such as manually writing any of the agent
member functions that <tt class="docutils literal"><span class="pre">cycpp</span></tt> generates, the prime directive should be all that
you ever need.  For example, an agent that does nothing and has no state variables
would be completely defined by the following thanks to the prime directive:</p>
<p><strong>The prime directive example:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre>class DoNothingCongress : public cyclus::Institution {
 public:
  DoNothingCongress(cyclus::Context* ctx) {};
  virtual ~DoNothingCongress() {};

  #pragma cyclus
};
</pre></div>
</div>
<br /><hr class="docutils" />
<p>For the times when you wish to break the prime directive, you may drill down
into more specific code generation routines.  These fit into three broad
categories:</p>
<ol class="arabic simple">
<li><strong>Declaration (decl) directives</strong>,</li>
<li><strong>Definition (def) directives</strong>, and</li>
<li><strong>Implementation (impl) directives</strong>.</li>
</ol>
<p>The <tt class="docutils literal"><span class="pre">decl</span></tt> directives generate only the member function declaration and must
be used from within the public part of the agent&#8217;s class declaration.  The
<tt class="docutils literal"><span class="pre">def</span></tt> generate the member function definition in its entirety including the
function signature.  These may be used either in the class declaration or in
the source file (<tt class="docutils literal"><span class="pre">*.cc</span></tt>, <tt class="docutils literal"><span class="pre">*.cpp</span></tt>, etc.).  The <tt class="docutils literal"><span class="pre">impl</span></tt> directives generate
only the body of the member function, leaving off the function signature.
These are useful for intercepting default behavior while still benefiting from
code generation.  These must be called from with the appropriate function
body.</p>
<p>The signature for the targeted code generation directives is as follows:</p>
<p><strong>Targeted code generation directive signatures:</strong></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus &lt;decl|def|impl&gt; [&lt;func&gt; [&lt;agent&gt;]]</span>
</pre></div>
</div>
<p>The first argument must be one of <tt class="docutils literal"><span class="pre">decl</span></tt>, <tt class="docutils literal"><span class="pre">def</span></tt>, or <tt class="docutils literal"><span class="pre">impl</span></tt>, which
determines the kind of code generation that will be performed.  The second,
optional <tt class="docutils literal"><span class="pre">&lt;func&gt;</span></tt> argument is the member function name that code should be
generated for. The third and final and optional <tt class="docutils literal"><span class="pre">&lt;agent&gt;</span></tt> argument is the
agent name to code generate for. This argument is useful in the face of
ambiguous or absent C++ scope.  The <tt class="docutils literal"><span class="pre">&lt;func&gt;</span></tt> argument must be present if
<tt class="docutils literal"><span class="pre">&lt;agent&gt;</span></tt> needs to be specified.</p>
<p>In the absence of optional arguments there are only:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus decl</span>
<span class="cp">#pragma cyclus def</span>
</pre></div>
</div>
<p>These generate all of the member function declarations and definitions,
respectively.  Note that there is no corresponding <tt class="docutils literal"><span class="pre">#pragma</span> <span class="pre">cyclus</span> <span class="pre">impl</span></tt>
because function bodies cannot be strung together without the corresponding
signatures encapsulating them.</p>
<p>When the <tt class="docutils literal"><span class="pre">&lt;func&gt;</span></tt> argument is provided the directive generates only the
definition, declaration, or implementation for the given agent API function.
For example the following would generate the definition for the <tt class="docutils literal"><span class="pre">schema()</span></tt>
function.</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus def schema</span>
</pre></div>
</div>
<p><a class="reference internal" href="#cycpp-table-3"><em>Table III. Member Function Flags and Their C++ Signatures</em></a> contains a listing of all available function flags and their
associated C++ information.</p>
<table border="1" class="styled-table centered docutils" id="cycpp-table-3">
<caption><strong>Table III.</strong> Member Function Flags and Their C++ Signatures</caption>
<colgroup>
<col width="10%" />
<col width="60%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="left-align no-left-divider single-right-divider head">func</th>
<th class="left-align single-left-divider single-right-divider head">C++ Signature</th>
<th class="left-align single-left-divider no-right-divider head">Return Type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">clone</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">Clone()</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">cyclus::Agent*</span></tt></td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">initfromcopy</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">InitFrom(MyAgent*</span> <span class="pre">m)</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">void</span></tt></td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">initfromdb</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">InitFrom(cyclus::QueryableBackend*</span> <span class="pre">b)</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">void</span></tt></td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">infiletodb</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">InfileToDb(cyclus::InfileTree*</span> <span class="pre">tree,</span>
<span class="pre">cyclus::DbInit</span> <span class="pre">di)</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">void</span></tt></td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">schema</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">schema()</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">std::string</span></tt></td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">annotations</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">annotations()</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">Json::Value</span></tt></td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">snapshot</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">Snapshot(cyclus::DbInit</span> <span class="pre">di)</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">void</span></tt></td>
</tr>
<tr class="row-odd"><td class="left-align no-left-divider single-right-divider">snapshotinv</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">SnapshotInv()</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">cyclus::Inventories</span></tt></td>
</tr>
<tr class="row-even"><td class="left-align no-left-divider single-right-divider">initinv</td>
<td class="left-align single-left-divider single-right-divider"><tt class="docutils literal"><span class="pre">InitInv(cyclus::Inventories&amp;</span> <span class="pre">inv)</span></tt></td>
<td class="left-align single-left-divider no-right-divider"><tt class="docutils literal"><span class="pre">void</span></tt></td>
</tr>
</tbody>
</table>
<br /><hr class="docutils" />
<p>Lastly, the agent&#8217;s classname may be optionally passed the to the directive.
This is most useful in source files for the definition directives. This is
because such directives typically lack the needed class scope.  For example,
for the snapshot definition of <tt class="docutils literal"><span class="pre">MyAgent</span></tt> living in <tt class="docutils literal"><span class="pre">mynamespace</span></tt> we would
use:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus def snapshot mynamespace::MyAgent</span>
</pre></div>
</div>
</div>
<div class="section" id="putting-it-together">
<h2>Putting It Together<a class="headerlink" href="#putting-it-together" title="Permalink to this headline">¶</a></h2>
<p><span style="font-variant:small-caps;">Cyclus</span> agents are written by declaring certain member variables to be
<strong>state variables</strong>.  This means that they <em>define</em> the conditions of the
agent at the start of every time step.  State variables are automatically are
saved and loaded to the database as well a dictating other important
interactions with the kernel.</p>
<p>The preprocessor will generate the desired implementation of key member
functions for your agent.  The easiest way to obtain these is through the
prime directive.</p>
<p>As a simple example, consider a reactor model that has three state variables:
a flux, a power level, and a flag for whether it is shutdown or not.
This could be implemented as follows:</p>
<div class="highlight-c++"><div class="highlight"><pre>class Reactor : public cyclus::Facility {
 public:
  Reactor(cyclus::Context* ctx) {};
  virtual ~Reactor() {};

  #pragma cyclus

 private:
  #pragma cyclus var {&#39;default&#39;: 4e14, \
                      &#39;doc&#39;: &#39;the core-average flux&#39;, \
                      &#39;units&#39;: &#39;n/cm2/2&#39;}
  double flux;

  #pragma cyclus var {&#39;default&#39;: 1000, &#39;units&#39;: &#39;MWe&#39;}
  float power;

  #pragma cyclus var {&#39;doc&#39;: &#39;Are we operating?&#39;}
  bool shutdown;
};
</pre></div>
</div>
<p>Note that the state variables may be private or protected if desired.
Furthermore annotations may be broken up over many lines using trailing
backslashes to make the code more readable.  It remains up to you - the module
developer - to implement the desired behavior and logic in the <tt class="docutils literal"><span class="pre">Tick()</span></tt> and
<tt class="docutils literal"><span class="pre">Tock()</span></tt> member functions.  Fancier tricks are available as needed but this
is the essence of how to write <span style="font-variant:small-caps;">Cyclus</span> agents.</p>
</div>
</div>
<div class="section" id="abusing-the-cyclus-preprocessor">
<h1>Abusing the <span style="font-variant:small-caps;">Cyclus</span> Preprocessor<a class="headerlink" href="#abusing-the-cyclus-preprocessor" title="Permalink to this headline">¶</a></h1>
<p>Now that you know how to use <tt class="docutils literal"><span class="pre">cycpp</span></tt>, it is useful to know about some of the
more advanced features and how they can be leveraged.</p>
<div class="section" id="scope-and-annotations">
<h2>Scope and Annotations<a class="headerlink" href="#scope-and-annotations" title="Permalink to this headline">¶</a></h2>
<p>Annotations dictionaries retain the C++ scope that they are defined in even
though they are written in Python.  This allows state variables to refer to
the annotations for previously declared state variables.  Since the scope is
retained, this allows annotations to refer to each other across agent/class
and namespace boundaries.</p>
<p>Because the annotations are dictionaries, the scoping is performed with the
Python scoping operator (<tt class="docutils literal"><span class="pre">.</span></tt>) rather than the C++ scoping operator (<tt class="docutils literal"><span class="pre">::</span></tt>).
For example, consider the case where we have a <tt class="docutils literal"><span class="pre">Spy</span></tt> class that lives in the
<tt class="docutils literal"><span class="pre">mi6</span></tt> namespace.  Also in the namespace is the spy&#8217;s <tt class="docutils literal"><span class="pre">Friend</span></tt>.
Furthermore, somewhere out in global scope lives the Spy&#8217;s arch-nemesis class
<tt class="docutils literal"><span class="pre">Enemy</span></tt>.</p>
<p>The first rule of scoping is that two state variables on the same class
share the same scope.  Thus they can directly refer to each other.</p>
<div class="highlight-c++"><div class="highlight"><pre>namespace mi6 {
class Spy {
  #pragma cyclus var {&quot;default&quot;: 7}
  int id;

  #pragma cyclus var {&quot;default&quot;: &quot;James Bond, {0:0&gt;3}&quot;.format(id[&#39;default&#39;])}
  std::string name;
};
}; // namespace mi6
</pre></div>
</div>
<p>In the above, <tt class="docutils literal"><span class="pre">id</span></tt> is used to help define the annotations for <tt class="docutils literal"><span class="pre">name</span></tt>.
Note that from within the annotations, other state variables are the annotation
dictionary that was previously defined.  They fo not take on the C++ default value.
This is why we could look up <tt class="docutils literal"><span class="pre">id['default']</span></tt>.</p>
<p>The second rule of scoping is that you are allowed to look into the annotations
of other classes.  However, to do so you must specifiy the class you are looking
into.  Looking at our spy&#8217;s friend</p>
<div class="highlight-c++"><div class="highlight"><pre>namespace mi6 {
class Friend {
  #pragma cyclus var {&quot;doc&quot;: &quot;Normally helps {0}&quot;.format(Spy.name[&#39;default&#39;])}
  std::string help_first;
};
}; // namespace mi6
</pre></div>
</div>
<p>Here, to access the annotations for Spy&#8217;s name we had to use <tt class="docutils literal"><span class="pre">Spy.name</span></tt>,
drilling into the Spy class. Inspecting in this way is not limited by C++
access control (public, private, or protected).</p>
<p>Lastly, if the agent we are trying to inspect lives in a completely different
namespace, we must first drill into that namespace. For example, the spy&#8217;s
main enemy is not part of <tt class="docutils literal"><span class="pre">mi6</span></tt>.  Thus to access the spy&#8217;s name annotations,
the enemy must write <tt class="docutils literal"><span class="pre">mi6.Spy.name</span></tt>. For example:</p>
<div class="highlight-c++"><div class="highlight"><pre>class Enemy {
    #pragma cyclus var {&#39;default&#39;: mi6.Spy.name[&#39;default&#39;]}
    std::string nemesis;
};
</pre></div>
</div>
</div>
<div class="section" id="inventories">
<h2>Inventories<a class="headerlink" href="#inventories" title="Permalink to this headline">¶</a></h2>
<p>In addition to the normal <a class="reference internal" href="dbtypes.html"><em>Database Types</em></a>, state variables may also be declared
with the <tt class="docutils literal"><span class="pre">cyclus::Inventories</span></tt> type.  This is a special <span style="font-variant:small-caps;">Cyclus</span> typedef
of <tt class="docutils literal"><span class="pre">std::map&lt;std::string,</span> <span class="pre">std::vector&lt;Resource::Ptr&gt;</span> <span class="pre">&gt;</span></tt> that enables the
storing of an arbitrary of resources (map values) by the associated commodity
(map key). While the concept of a resource inventory may be implemented in many
ways, the advantage in using the <tt class="docutils literal"><span class="pre">cyclus::Inventories</span></tt> is that the <span style="font-variant:small-caps;">Cyclus</span>
kernel knows how to save and load this type as well as represent it in RNG.
Inventories may be used as normal state variables.  For example:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus var {&#39;doc&#39;: &#39;my stocks&#39;}</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">Inventories</span> <span class="n">invs</span><span class="p">;</span>
</pre></div>
</div>
<p>It is therefore <em>hightly</em> recommended that you store resources in this
data structure.</p>
</div>
<div class="section" id="state-variable-code-generation-overrides">
<h2>State Variable Code Generation Overrides<a class="headerlink" href="#state-variable-code-generation-overrides" title="Permalink to this headline">¶</a></h2>
<p>A powerful feature of most of the code generation directives is that the
C++ code that is created for a state variable may be optionally replaced with a
code snippet writing in the annotations. This allows you to selectively
define the C++ behavior without the need to fully rewrite the member function.</p>
<p>A potential use case is to provide a custom schema while still utilizing all other
parts of <tt class="docutils literal"><span class="pre">cycpp</span></tt>.  For example:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#pragma cyclus var {&#39;schema&#39;: &#39;&lt;my&gt;Famcy RNG here&lt;/my&gt;&#39;}</span>
<span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">fibonacci</span><span class="p">;</span>
</pre></div>
</div>
<p>This will override the schema only for the Fibonacci state variable.  For a
listing of all code generation functions that may be overridden, please see
<a class="reference internal" href="#cycpp-table-1"><em>Table I. Special State Variable Annotations</em></a>.</p>
</div>
<div class="section" id="implementation-hacks">
<h2>Implementation Hacks<a class="headerlink" href="#implementation-hacks" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">impl</span></tt> code generation directives exist primarily to be abused.  Unlike
the <tt class="docutils literal"><span class="pre">def</span></tt> directives, the implementation directives do not include the
function signature or return statement.  The downside of this is that you must
provide the function signature and the return value yourself.  The upside is
that you may perform any operation before &amp; after the directive!</p>
<p>For example, suppose that we wanted to make sure that the flux state variable
on the Reactor agent is always snapshotted to the database as the value 42.
However, we did not want to permanently alter the value of this variable.
This could be achieved through the following pattern:</p>
<div class="highlight-c++"><div class="highlight"><pre>void Reactor::Snapshot(cyclus::DbInit di) {
  double real_flux = flux;  // copy the existsing fluc value.
  flux = 42;  // set the value to wat we want temporarily

  // fill in the code generated implementation of Shapshop()
  #prama cyclus impl snapshot Reactor

  flux = real_flux;  // reset the flux
}
</pre></div>
</div>
<p>There are likely much more legitimate uses for this feature. For a complete
listing of the member function information, please see <a class="reference internal" href="#cycpp-table-3"><em>Table III. Member Function Flags and Their C++ Signatures</em></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/big_c.png" alt="Logo"/>
        </a></p><div class="sphinxlocaltoc">
    <h3><a href="../index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Using the Cyclus Preprocessor</a><ul>
<li><a class="reference internal" href="#pragma-cyclus">Pragma <span style="font-variant:small-caps;">Cyclus</span></a></li>
<li><a class="reference internal" href="#annotation-directives">Annotation Directives</a></li>
<li><a class="reference internal" href="#code-generation-directives">Code Generation Directives</a></li>
<li><a class="reference internal" href="#putting-it-together">Putting It Together</a></li>
</ul>
</li>
<li><a class="reference internal" href="#abusing-the-cyclus-preprocessor">Abusing the <span style="font-variant:small-caps;">Cyclus</span> Preprocessor</a><ul>
<li><a class="reference internal" href="#scope-and-annotations">Scope and Annotations</a></li>
<li><a class="reference internal" href="#inventories">Inventories</a></li>
<li><a class="reference internal" href="#state-variable-code-generation-overrides">State Variable Code Generation Overrides</a></li>
<li><a class="reference internal" href="#implementation-hacks">Implementation Hacks</a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="cmake.html"
                          title="Previous page">&larr; Building Modules with CMake</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="testing.html"
                          title="Next page">&rarr; Testing Agents and Modules</a></p>
  </div>
  <div class="sphinxlocaltoc">
  <h3>Useful Pages</h3>
    <ul><li><ul>
    <li><a href="http://fuelcycle.org/user/main.html">User Guide</a></li>
    <li><a href="http://fuelcycle.org/module/main.html">Archetype Developer Guide</a></li>
    <li><a href="http://fuelcycle.org/cyclus/api/">Cyclus API Documentation</a></li>
    <li><a href="http://fuelcycle.org/cycamore/api/">Cycamore API Documentation</a></li>
    <li><a href="http://fuelcycle.org/basics/glossary.html">Glossary</a></li>
    <li><a href="mailto:cyclus-users+subscribe@googlegroups.com?subject=Subscribe&body=Send this message to subscribe to the list">Join</a> the 
      <a href="https://groups.google.com/forum/#!forum/cyclus-users" target="_blank"><span style="font-variant:small-caps">Cyclus</span> Users</a> mailing list.
    <li><a href="mailto:cyclus-dev+subscribe@googlegroups.com?subject=Subscribe&body=Send this message to subscribe to the list">Join</a> the 
      <a href="https://groups.google.com/forum/#!forum/cyclus-users" target="_blank"><span style="font-variant:small-caps">Cyclus</span> Developers</a> mailing list.
    </ul></li></ul>
  </div>
    
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
    <h3>Get Cyclus</h3>
    <br>
    Current version: <b>1.0.0</b>
    <br><br>
    Install:
    <div class="highlight-bash" style="width:97.5%"><div class="highlight"><pre><span class="nv">$ </span>conda install cyclus cycamore</pre></div></div>
    Get the Source:
    <ul><li><ul>
          <li><a href="https://github.com/cyclus/cyclus">Cyclus</a></li>
          <li><a href="https://github.com/cyclus/cycamore">Cycamore</a></li>
    </ul></li></ul>
    <h3>Acknowledgements</h3>
    The Cyclus project has received support from:
    <br />
    <a href="http://www.neup.gov" target="_blank"><img src="../_static/neup_logo_large.png" width=170px></a>
    <br />
    <br />

    In addition, some of the students working on Cyclus have received support from:
    <br />
    <a href="http://www.anl.gov" target="_blank"><img src="../_static/AnlLogo.png" height=100px></a>
    <a href="http://www.nrc.gov" target="_blank"><img src="../_static/USNRC.png" height=100px></a>
    <br />
    <a href="http://www.neup.gov" target="_blank"><img src="../_static/neup_logo_large.png" width=170px></a>
    <br />
    <a href="http://www.nsf.gov" target="_blank"><img src="../_static/nsf_logo.png" height=100px></a>
    <a href="http://www.wisc.edu" target="_blank"><img src="../_static/crest.png" height=100px></a>

    

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="testing.html" title="Testing Agents and Modules"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="cmake.html" title="Building Modules with CMake"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Home</a> &raquo;</li>

          <li><a href="main.html" ><span style="font-variant:small-caps;">Cyclus</span> Archetype Developer Guide</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012-2014, University of Wisconsin Computational Nuclear Engineering Research Group.
      Last updated on Jun 07, 2014.
    </div><script type="text/javascript">
    if(ga_enabled){
        document.write("<div class=\"footer\">This page uses <a href=\"http://analytics.google.com\">Google Analytics</a> to collect statistics. ");
        document.write("Click <button title=\"set cookie to disable analytics for this site\" class=\"link\" onclick=\"$.cookie('disable-ga', 'true', {expires: 3650, path: '/'}); window.location.reload(); return false; \">here</button> to disable analytics for this site.");
        document.write("</div>");
    }else{
        document.write("<div class=\"footer\">Google Analytics has been disabled. ");
        document.write("Click <button title=\"set cookie to re-enable analytics for this site\" class=\"link\" onclick=\"$.cookie('disable-ga', null, {path: '/'}); window.location.reload(); return false; \">here</button> to re-enable analytics for this site.");
    };
</script>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>